{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pomodoro Timer</title>
  <script defer src="script.js"></script>

  <script src="{% static 'core/pomodoro.js' %}"></script>
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-blue-50 text-gray-800">
  <!-- Back Button -->
  <a href="#" class="absolute top-4 left-4 text-blue-500 hover:text-blue-700 flex items-center">
    <!-- Back Arrow Icon -->
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
    Back
  </a>

  <div class="min-h-screen flex flex-col items-center justify-center px-4">
    <h1 class="text-4xl font-bold text-blue-600 mb-6">Pomodoro Timer</h1>

    <!-- Current Session Display -->
    <p id="current-session" class="text-2xl font-semibold mb-4 text-purple-500">Study Session</p>

    <!-- Digital Clock -->
    <div class="timer bg-white p-8 rounded-lg shadow-lg mb-6">
      <h2 class="text-7xl font-bold text-purple-500" id="time-display">25:00</h2>
    </div>

    <!-- Timer Control Buttons -->
    <div class="flex space-x-4 mb-6">
      <button id="start-timer" class="bg-green-400 text-white px-5 py-3 rounded-lg hover:bg-green-500">Start</button>
      <button id="stop-timer" class="bg-red-400 text-white px-5 py-3 rounded-lg hover:bg-red-500">Stop</button>
      <button id="reset-timer" class="bg-gray-400 text-white px-5 py-3 rounded-lg hover:bg-gray-500">Reset</button>
    </div>

    <!-- Session Switch Buttons -->
    <div class="flex space-x-4 mb-6">
      <button id="switch-to-study" class="bg-purple-300 text-white px-4 py-2 rounded-lg hover:bg-purple-400">Study Session</button>
      <button id="switch-to-short-break" class="bg-green-300 text-white px-4 py-2 rounded-lg hover:bg-green-400">Short Break</button>
      <button id="switch-to-long-break" class="bg-yellow-300 text-white px-4 py-2 rounded-lg hover:bg-yellow-400">Long Break</button>
    </div>

    <!-- Change Time Buttons -->
    <div class="flex space-x-4 mb-6">
      <button id="set-study-time" class="bg-blue-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-blue-300">Set Study Time</button>
      <button id="set-short-break-time" class="bg-green-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-green-300">Set Short Break Time</button>
      <button id="set-long-break-time" class="bg-yellow-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-yellow-300">Set Long Break Time</button>
    </div>

    <!-- Session and Break Counters -->
    <div class="text-center mb-6">
      <p class="text-lg">Sessions Completed: <span id="session-count" class="font-semibold">0</span></p>
      <p class="text-lg">Breaks Taken: <span id="break-count" class="font-semibold">0</span></p>
      <p class="text-lg">Study Cycles Completed: <span id="cycle-count" class="font-semibold">0</span></p>
    </div>

    <!-- Cycle Completion Message -->
    <div id="cycle-message" class="hidden text-center bg-pink-100 text-gray-800 p-4 rounded-lg">
      <p id="cycle-message-text" class="text-lg font-semibold"></p>
    </div>
  </div>
  <script>

    // Fetch timer settings from the backend when the page loads
async function getTimerSettings() {
  const response = await fetch('/timer-settings');
  const data = await response.json();

  // Update the times from backend
  studyTime = data.study_time;
  shortBreakTime = data.short_break_time;
  longBreakTime = data.long_break_time;
  sessionCount = data.session_count;
  breakCount = data.break_count;
  cycleCount = data.cycle_count;

  updateTimeDisplay();
  sessionCountDisplay.textContent = sessionCount;
  breakCountDisplay.textContent = breakCount;
  cycleCountDisplay.textContent = cycleCount;
}

// Function to send updated stats to the backend
async function updateStats() {
  const response = await fetch('/update-stats', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      session_count: sessionCount,
      break_count: breakCount,
      cycle_count: cycleCount
    })
  });

  const result = await response.json();
  console.log(result.message);
}

// Function to send updated timer durations to the backend
async function updateTimer() {
  const response = await fetch('/update-timer', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      study_time: studyTime,
      short_break_time: shortBreakTime,
      long_break_time: longBreakTime
    })
  });

  const result = await response.json();
  console.log(result.message);
}

// Call the backend API to get timer settings when the page loads
window.onload = getTimerSettings;

// You can call updateStats() whenever you update the stats on the frontend
// e.g., after completing a session or break


// Variables for timer
let studyTime = 25 * 60; // 25 minutes in seconds
let shortBreakTime = 5 * 60;  // 5 minutes in seconds
let longBreakTime = 15 * 60;  // 15 minutes in seconds
let currentTimer = studyTime;
let sessionCount = 0;
let breakCount = 0;
let cycleCount = 0;
let timerInterval = null;
let currentSession = "study"; // 'study', 'short-break', 'long-break'

// DOM Elements
const timeDisplay = document.getElementById("time-display");
const sessionCountDisplay = document.getElementById("session-count");
const breakCountDisplay = document.getElementById("break-count");
const currentSessionDisplay = document.getElementById("current-session");
const cycleCountDisplay = document.getElementById("cycle-count");
const cycleMessageDiv = document.getElementById("cycle-message");
const cycleMessageText = document.getElementById("cycle-message-text");

// Format time into mm:ss
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Update the time display
function updateTimeDisplay() {
  timeDisplay.textContent = formatTime(currentTimer);
}

// Start Timer
function startTimer() {
  if (timerInterval) return; // Prevent multiple intervals

  timerInterval = setInterval(() => {
    currentTimer--;
    updateTimeDisplay();

    if (currentTimer <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      handleSessionSwitch(); // Automatically switch to next session when time is up
    }
  }, 1000);
}

// Stop Timer
function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

// Reset Timer
function resetTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
  currentSession = "study";
  currentTimer = studyTime;
  sessionCount = 0;
  breakCount = 0;
  cycleCount = 0;
  updateSessionDisplay();
  updateTimeDisplay();
  sessionCountDisplay.textContent = sessionCount;
  breakCountDisplay.textContent = breakCount;
  cycleCountDisplay.textContent = cycleCount;
  hideCycleMessage();
}

// Update the session display (study, short break, or long break)
function updateSessionDisplay() {
  if (currentSession === "study") {
    currentSessionDisplay.textContent = "Study Session";
    currentSessionDisplay.className = "text-2xl font-semibold mb-4 text-purple-500";
  } else if (currentSession === "short-break") {
    currentSessionDisplay.textContent = "Short Break";
    currentSessionDisplay.className = "text-2xl font-semibold mb-4 text-green-500";
  } else if (currentSession === "long-break") {
    currentSessionDisplay.textContent = "Long Break";
    currentSessionDisplay.className = "text-2xl font-semibold mb-4 text-yellow-500";
  }
}

// Handle session switching
function handleSessionSwitch() {
  if (currentSession === "study") {
    sessionCount++;
    sessionCountDisplay.textContent = sessionCount;

    if (sessionCount % 4 === 0) {
      switchToLongBreak(); // Switch to long break every 4th study session
    } else {
      switchToShortBreak(); // Switch to short break after other study sessions
    }
  } else {
    breakCount++;
    breakCountDisplay.textContent = breakCount;

    if (currentSession === "long-break") {
      cycleCount++;
      cycleCountDisplay.textContent = cycleCount;
      showCycleMessage(cycleCount); // Show the cycle completion message
    }

    switchToStudy(); // Switch back to study session after a break
  }
}

// Manually switch to study session
function switchToStudy() {
  currentSession = "study";
  currentTimer = studyTime;
  updateSessionDisplay();
  updateTimeDisplay();
  startTimer(); // Automatically start the next session
}

// Manually switch to short break
function switchToShortBreak() {
  currentSession = "short-break";
  currentTimer = shortBreakTime;
  updateSessionDisplay();
  updateTimeDisplay();
  startTimer(); // Automatically start the next session
}

// Manually switch to long break
function switchToLongBreak() {
  currentSession = "long-break";
  currentTimer = longBreakTime;
  updateSessionDisplay();
  updateTimeDisplay();
  startTimer(); // Automatically start the next session
}

// Show cycle completion message
function showCycleMessage(cycleNumber) {
  cycleMessageText.textContent = `ðŸŽ‰ Great job! You've completed study cycle ${cycleNumber}! ðŸŽ‰`;
  cycleMessageDiv.classList.remove("hidden");

  // Hide the message after some time
  setTimeout(() => {
    hideCycleMessage();
  }, 5000);
}

// Hide cycle completion message
function hideCycleMessage() {
  cycleMessageDiv.classList.add("hidden");
}

// Set Study Time
document.getElementById("set-study-time").addEventListener("click", () => {
  const newStudyTime = prompt("Enter study time in minutes:");
  if (newStudyTime && !isNaN(newStudyTime)) {
    studyTime = newStudyTime * 60;
    if (currentSession === "study") {
      currentTimer = studyTime;
      updateTimeDisplay();
    }
  }
});

// Set Short Break Time
document.getElementById("set-short-break-time").addEventListener("click", () => {
  const newShortBreakTime = prompt("Enter short break time in minutes:");
  if (newShortBreakTime && !isNaN(newShortBreakTime)) {
    shortBreakTime = newShortBreakTime * 60;
    if (currentSession === "short-break") {
      currentTimer = shortBreakTime;
      updateTimeDisplay();
    }
  }
});

// Set Long Break Time
document.getElementById("set-long-break-time").addEventListener("click", () => {
  const newLongBreakTime = prompt("Enter long break time in minutes:");
  if (newLongBreakTime && !isNaN(newLongBreakTime)) {
    longBreakTime = newLongBreakTime * 60;
    if (currentSession === "long-break") {
      currentTimer = longBreakTime;
      updateTimeDisplay();
    }
  }
});

// Button Click Listeners
document.getElementById("start-timer").addEventListener("click", startTimer);
document.getElementById("stop-timer").addEventListener("click", stopTimer);
document.getElementById("reset-timer").addEventListener("click", resetTimer);

document.getElementById("switch-to-study").addEventListener("click", switchToStudy);
document.getElementById("switch-to-short-break").addEventListener("click", switchToShortBreak);
document.getElementById("switch-to-long-break").addEventListener("click", switchToLongBreak);

// Initial Setup
updateSessionDisplay();
updateTimeDisplay();
sessionCountDisplay.textContent = sessionCount;
breakCountDisplay.textContent = breakCount;
cycleCountDisplay.textContent = cycleCount;


  </script>
</body>
</html>
